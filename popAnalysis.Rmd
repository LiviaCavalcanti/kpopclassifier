---
title: "O que o pop da Coreia tem a ver com o dos EUA"
author: "Lívia Cavalcanti e Marcus Vinícius"
date: "3 de julho de 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=F}
library(tidyverse)
theme_set(theme_bw())
library(broom)
library(modelr) 
library(corrplot)
library(gridExtra)

```

# Os dados

```{r echo=FALSE}
song_features = read_csv(here::here("data/new_song_features.csv")) 
artist_followers = read_csv(here::here("data/artists_name_and_followers.csv")) 
summary(song_features)
glimpse(artist_followers)
```


```{r}
song_artist_data = inner_join(artist_followers, song_features)
temp=song_artist_data %>% select(-isKPop, -isExplicit, -albumName, -song_name, -artist_name, -release_date)
m=cor(temp)
corrplot(m, method="color")

```

```{r}
kpop = song_artist_data %>% filter(isKPop=="True") %>% select(-instrumentalness, -isKPop, -isExplicit) #intrumentalness ~ 0, isExplicit == FALSE
kpop_cor = kpop %>% select(-artist_name, -albumName, -song_name, -release_date)
kpop_cor = cor(kpop_cor)
corrplot(kpop_cor, method="color")
```

```{r}
apop = song_artist_data %>% filter(isKPop=="False") %>% select(-isKPop) 
apop_cor = apop %>% select(-artist_name, -albumName, -song_name, -release_date, -isExplicit)
apop_cor = cor(apop_cor)
corrplot(apop_cor, method="color")
```

```{r}
kpop_cor
```
energy, followers, sppeechiness, instrumentalness

tempo,time_signature, totalArtists, albumTotalTracks
```{r}
plots <- function(song_data) {
  dance<-song_data %>%
    ggplot() +
      geom_density(aes(danceability)) 
  tempo<-song_data %>%
    ggplot() +
    geom_density(aes(tempo))
  pop<-song_data %>%
    ggplot() +
    geom_density(aes(popularity))
  totArt <- song_data %>%
    ggplot() +
    geom_density(aes(totalArtists))
  totalTrack<-song_data %>%
    ggplot() +
    geom_density(aes(albumTotalTracks))
  energy<-song_data %>%
    ggplot() +
    geom_density(aes(energy))
  speech<-song_data %>%
    ggplot() +
    geom_density(aes(speechiness))
  acoustic <- song_data %>%
    ggplot() +
    geom_density(aes(acousticness))
  # song_data %>%
  #   ggplot() +
  #   geom_density(aes(instrumentalness))
  live <- song_data %>%
    ggplot() +
    geom_density(aes(liveness))
  val <- song_data %>%
    ggplot() +
    geom_density(aes(valence))
  dur <- song_data %>%
    ggplot() +
    geom_density(aes(duration_ms)) +
    theme(axis.text.x = element_text(angle=90))
  
  grid.arrange(dance, tempo, pop, totArt, totalTrack, energy, speech, acoustic, live, val, dur, nrow = 3)

}


```

```{r}

plots(apop)
```

```{r}
plots(kpop)
```

## Análise com regressão

Nesta sessão, discutiremos quais variáveis melhor explicam a popularidade de uma música, e para isso, iremos realizar diversos experimentos utilizando regressão linear, a fim de, obter uma (ou várias) variável que explica muito bem o por que daquela música ser popular.



 Características que serão analisadas: Duração da música (em ms), 

### Popularidade de uma música vs Tempo de duração (em milisegundos)

#### PARA KPOP

Primeiramente, iremos visualizar um gráfico de pontos dessas duas variáveis para tentar traçar padrões.

```{r}
kpop %>% ggplot(aes(x=popularity, y = duration_ms)) + geom_point() + geom_smooth(method = "lm", se = FALSE)
```

Podemos notar inicialmente que, a variável duração da música, a principio, não explica muito bem o por que de uma música ser popular. Vamos confirmar essa hipotése com um modelo de regressão linear.

```{r}

modelo_duration <- lm(popularity ~ duration_ms , 
          data = kpop)

```
Modelo obtido:
```{r}
tidy(modelo_duration)

```

Seu R²:

```{r}
glance(modelo_duration)
```

Como já desconfiavamos, a variável duração, sozinha, não explica muito o por que de uma música ser popular, e isso pode ser confirmado pelo coeficiente R² obtido na regressão linear, que nos diz que, a variável duration só explica 1% a variável popularidade.

#### PARA POP AMERICANO

Primeiramente, iremos visualizar um gráfico de pontos dessas duas variáveis para tentar traçar padrões.

```{r}
apop %>% ggplot(aes(x=popularity, y = duration_ms)) + geom_point() + geom_smooth(method = "lm", se = FALSE)
```

Para as músicas populares americanas, podemos notar que, a variável duração já tem uma maior taxa de explicação sobre a variável popularidade. Vamos confirmar essa tese com um modelo de regressão linear.

```{r}

modelo_duration_apop <- lm(popularity ~ duration_ms , 
          data = apop)

```
Modelo obtido:
```{r}
tidy(modelo_duration_apop)

```

Seu R²:

```{r}
glance(modelo_duration_apop)
```

Como podemos perceber, para o cenário de músicas populares americanas, a variável duração explica muito melhor a variável popularidade do que em relação ao cenário de músicas de kpop. Essa melhoria pode ser notada pelo valor do R² obtido na regressão, que para esse cenário, explica em 20%. Por mais que esse valor ainda não seja o ideal, podemos notar uma boa mudança de valores apenas mudando as regiões (países) de interesse. É importante lembrar também que, esse valor foi obtido a partir de uma regressão linear simples, logo, existe apenas uma variável tentando explicar outra, sendo mais dificil obter valores maiores.




### Popularidade de uma música vs Nível de Acoustica

#### PARA KPOP

Primeiramente, iremos visualizar um gráfico de pontos dessas duas variáveis para tentar traçar padrões.

```{r}
kpop %>% ggplot(aes(x=popularity, y = acousticness)) + geom_point() + geom_smooth(method = "lm", se = FALSE)
```

Podemos notar inicialmente que, a variável acousticness, que nos diz uma escala entre [0-1] não possui um bom teor de explicação sobre a variável popularidade, e isso pode ser percebido pela reta de regressão feita no gráfico, que não divide muito bem os pontos. Para confirmar essa tese, faremos o modelo de regressão abaixo.

```{r}

modelo_acousticness <- lm(popularity ~ acousticness , 
          data = kpop)

```
Modelo obtido:
```{r}
tidy(modelo_acousticness)

```

Seu R²:

```{r}
glance(modelo_acousticness)
```

Como já desconfiavamos, a variável acousticness se mostrou péssima para explicar a variável de popularidade de uma música, essa confirmação pode ser notada pelo valor do R² obtido, que é extremamente baixo. A conclusão que obtemos é, para o cenário de Kpop, uma música ser inteiramente acoustica ou inteiramente não-acoustica não influencia muito na sua popularidade.

#### PARA POP AMERICANO

Primeiramente, iremos visualizar um gráfico de pontos dessas duas variáveis para tentar traçar padrões.

```{r}
apop %>% ggplot(aes(x=popularity, y = acousticness)) + geom_point() + geom_smooth(method = "lm", se = FALSE)
```

Por mais que, aparentemente a variável ainda não demonstre ter um bom teor de explicação sobre a variável popularidade, podemos ver que para o cenário de músicas populares americanas, essa variável já consegue, aparentemente, explicar um pouco melhor em relação ao cenário de kpop. Confirmaremos abaixo. 

```{r}

modelo_acousticness_apop <- lm(popularity ~ acousticness , 
          data = apop)

```
Modelo obtido:
```{r}
tidy(modelo_acousticness_apop)

```

Seu R²:

```{r}
glance(modelo_acousticness_apop)
```

Como podemos perceber, para o cenário de músicas populares americanas, a variável acousticness continua bastante inexpressiva para sua função (5% de explicação, segundo o R²), que é explicar a variável popularidade de uma música, no entanto, cumpre seu papel com mais eficácia nos dados de músicas populares americanas. A conclusão geral é, em ambos os cenários (kpop e apop), essa variável se mostrou bastante fraca para explicar o quão popular uma música é.

### Vendo o que temos mais por aqui

A partir das matrizes de correlações algumas features foram escolhidas para vermos seus níveis de explicabilidade. São elas energy, followers, sppeechiness, instrumentalness, a partir da matriz de K-Pop e tempo,time_signature, totalArtists, albumTotalTracks, da matriz de A-Pop.

```{r}
modelo_energy_kpop <- lm(popularity ~ energy,
                         data=kpop)
modelo_followers_kpop <- lm(popularity ~ followers,
                         data=kpop)
modelo_speechiness_kpop <- lm(popularity ~ speechiness,
                         data=kpop)
modelo_tempo_kpop <- lm(popularity ~ tempo,
                         data=kpop)
modelo_time_signature_kpop <- lm(popularity ~ time_signature,
                         data=kpop)
modelo_totalArtists_kpop <- lm(popularity ~ totalArtists,
                         data=kpop)
modelo_albumTotalTracks_kpop <- lm(popularity ~ albumTotalTracks,
                         data=kpop)

modelo_energy_apop <- lm(popularity ~ energy,
                         data=apop)
modelo_followers_apop <- lm(popularity ~ followers,
                         data=apop)
modelo_speechiness_apop <- lm(popularity ~ speechiness,
                         data=apop)
modelo_instrumentalness_apop <- lm(popularity ~ instrumentalness,
                         data=apop)
modelo_tempo_apop <- lm(popularity ~ tempo,
                         data=apop)
modelo_time_signature_apop <- lm(popularity ~ time_signature,
                         data=apop)
modelo_totalArtists_apop <- lm(popularity ~ totalArtists,
                         data=apop)
modelo_albumTotalTracks_apop <- lm(popularity ~ albumTotalTracks,
                         data=apop)


```

```{r}
tidy(modelo_energy_kpop)

glance(modelo_energy_kpop)
```

```{r}
tidy(modelo_energy_apop)

glance(modelo_energy_apop)
```

```{r}
tidy(modelo_followers_kpop)

glance(modelo_followers_kpop) ################
```

```{r}
tidy(modelo_followers_apop)

glance(modelo_followers_apop)
```

```{r}
tidy(modelo_speechiness_kpop)

glance(modelo_speechiness_kpop)
```

```{r}
tidy(modelo_speechiness_apop)

glance(modelo_speechiness_apop)
```

```{r}
tidy(modelo_time_signature_kpop)

glance(modelo_time_signature_kpop)
```

```{r}
tidy(modelo_time_signature_apop)

glance(modelo_time_signature_apop)
```

```{r}
tidy(modelo_tempo_kpop)

glance(modelo_tempo_kpop)
```

```{r}
tidy(modelo_tempo_apop)

glance(modelo_tempo_apop)
```

```{r}
tidy(modelo_totalArtists_kpop)

glance(modelo_totalArtists_kpop)
```

```{r}
tidy(modelo_totalArtists_apop)

glance(modelo_totalArtists_apop)
```

```{r}
tidy(modelo_albumTotalTracks_kpop)

glance(modelo_albumTotalTracks_kpop)
```

```{r}
tidy(modelo_albumTotalTracks_apop)

glance(modelo_albumTotalTracks_apop)
```

### O que conseguimos com esses resultados?

A partir de todos esses números, tentamos juntá-los, mas, como esperado, uma regressão múltipla não gera um R² ajustado composto dos modelos simples. Buscamos selecionar os mais promissores modelos dos vistos acima a partir desta mesma métrica, visto que muitas variáveis, ainda que tenham correlação significativa, se mostraram pobres no cenário de regressão para o alvo `popularity`. Entretanto, facilmente, foi atingido um limiar superior de explicabilidade possível utilizando os dados disponíveis que é muito próximo do R² obtido com a regressão simples obtida utilizando a variável mais explicativa.


Para o modelo K-Pop foram testadas as variáveis `followers`, `albumTotalTracks`, `totalArtists`, `tempo`, `time_signature`, `acousticness`. Apesar do R² chegar a 71%, o R² ajustado não passou 69%. Da mesma forma, foram testadas `followers`, `albumTotalTracks`, `totalArtists`, `tempo`, `time_signature`, `acousticness`, `speechiness`, mas o R² ajustado alcançou apenas 27%.


Como limiares foram atingidos a despeito da quantidade de features utilizadas, preferimos deixar as mais essenciais para manter, aproximadamente, a magnitude do R² ajustado sem muitas perdas. 


Com isso, os resultados foram:
```{r}

modelo_kpop <- lm(popularity ~ followers +  tempo, 
                 data=kpop)

tidy(modelo_kpop, conf.int = TRUE)

glance(modelo_kpop)
```

```{r}
modelo_apop <- lm(popularity ~ acousticness +  duration_ms + followers + energy , 
                 data=apop)

tidy(modelo_apop, conf.int = TRUE)

glance(modelo_apop)
```

### E o que esses modelos significam?